<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stylophone Simulator</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            font-family: "Roboto Mono", monospace;
            touch-action: none; /* Disable touch scrolling on the body */
            background-color: #3a3a3a;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .stylophone-container {
            width: 100%;
            max-width: 550px; /* Adjust max-width to match the proportions better */
            background-color: #222; /* Main body color, dark grey/black */
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4), inset 0 2px 5px rgba(255,255,255,0.1);
            overflow: hidden; /* For rounded corners */
            position: relative;
            padding-bottom: 20px; /* Space for the bottom white part */
        }

        .top-section {
            background-color: #000;
            padding: 15px 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }

        .speaker-area {
            background-color: #000; /* Speaker area background */
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .speaker-grille-bg {
            background-color: #333;
            border-radius: 4px;
            padding: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            height: 70px; /* Fixed height for the grille */
            display: flex; /* Use flex for horizontal lines */
            flex-direction: column;
            justify-content: space-between;
        }

        .grille-line {
            height: 2px;
            background: repeating-linear-gradient(90deg, #b0b0b0, #b0b0b0 4px, #777 4px, #777 8px);
            border-radius: 1px;
            width: 100%;
        }

        .stylophone-logo {
            position: absolute;
            top: 25px; /* Adjust based on grille position */
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif; /* Futuristic font */
            font-size: 2rem;
            color: #ccc;
            text-shadow: 0 0 5px rgba(0,255,255,0.5);
            letter-spacing: 2px;
            z-index: 10;
        }
        .stylophone-logo::after {
            content: '®';
            font-size: 0.5em;
            vertical-align: super;
            margin-left: -5px;
        }

        .stylus-slot-area {
            background-color: #000;
            padding: 5px 0;
            display: flex;
            align-items: center;
            position: relative;
            margin-bottom: 5px;
        }

        .stylus-label {
            color: #aaa;
            font-size: 0.75rem;
            font-family: "Roboto Mono", monospace;
            padding-left: 10px;
            letter-spacing: 1px;
        }

        .stylus-slot {
            flex-grow: 1;
            height: 8px;
            background-color: #111;
            border-radius: 4px;
            margin: 0 10px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        .middle-controls {
            display: flex;
            padding: 10px 20px 0;
            background-color: #222;
        }

        .left-controls {
            background-color: #eee; /* White background for controls */
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
            margin-right: 15px; /* Space from keyboard */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .switch-group {
            display: flex;
            flex-direction: column;
            font-size: 0.65rem;
            color: #555;
            text-align: left;
        }

        .toggle-switch-container {
            position: relative;
            width: 30px;
            height: 15px;
            background-color: #999;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }

        .toggle-switch {
            position: absolute;
            width: 13px;
            height: 13px;
            background-color: #fff;
            border-radius: 50%;
            top: 1px;
            left: 1px;
            transition: transform 0.2s;
            border: 1px solid #777;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .toggle-switch.on {
            transform: translateX(15px);
            background-color: #4CAF50; /* Green for ON */
        }
        .toggle-switch-container.vibrato .toggle-switch.on {
            background-color: #ff9800; /* Orange for VIBRATO */
        }

        .selector-switch {
            width: 30px;
            height: 20px;
            background-color: #999;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }

        .selector-handle {
            position: absolute;
            width: 100%;
            height: 50%; /* For 2 positions */
            background-color: #fff;
            left: 0;
            top: 0;
            transition: top 0.2s;
            border-bottom: 1px solid #777;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            color: #333;
            font-weight: bold;
        }
        .selector-handle.pos2 { /* For middle position in 3-way */
             top: 50%;
        }
        .selector-handle.pos3 { /* For bottom position in 3-way */
             top: 100%; /* Will be set to 66% height if 3 way */
             transform: translateY(-100%);
        }

        .selector-switch.tone .selector-handle {
            height: 33.3%;
        }
        .selector-switch.tone .selector-handle.pos1 { top: 0; }
        .selector-switch.tone .selector-handle.pos2 { top: 33.3%; }
        .selector-switch.tone .selector-handle.pos3 { top: 66.6%; }

        .keyboard-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #eee; /* White background behind keys */
            border-radius: 6px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            position: relative; /* For absolute positioning of labels */
            padding: 5px; /* Inner padding */
        }
        
        /* --- NEW SONG PLAYER STYLES --- */
        .song-player-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #ddd;
            border-radius: 4px;
        }
        #song-selector {
            flex-grow: 1;
            font-family: "Roboto Mono", monospace;
            font-size: 0.8rem;
            border: 1px solid #999;
            border-radius: 3px;
            padding: 4px;
            background-color: #fff;
            overflow: hidden; /* For long song names */
        }
        .song-player-controls button {
            font-family: "Roboto Mono", monospace;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 3px;
            border: 1px solid #999;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            flex-shrink: 0;
        }
        .song-player-controls button:active {
            background-color: #eee;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .song-player-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #play-song-btn {
            background-color: #a5d6a7; /* Light green */
            border-color: #7a9c7b;
        }
        #stop-song-btn {
            background-color: #ef9a9a; /* Light red */
            border-color: #b17474;
        }
        #note-display {
            width: 40px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border: 1px solid #999;
            border-radius: 3px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #333;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        /* --- END SONG PLAYER STYLES --- */

        /* --- NEW KEYBOARD STYLES --- */
        .top-labels-row {
            display: flex;
            height: 25px; /* Height for the top label row */
            margin-bottom: 2px;
            position: relative;
            padding-left: calc(100% / 12 / 2); /* Offset to align with gaps */
            box-sizing: border-box;
        }
        .top-label-segment {
            flex: 1; /* Each segment takes equal space */
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #333;
            font-weight: bold;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        .top-label-segment.spacer {
            flex: 1; /* A gap segment */
        }
        .top-label-line {
            /* This is no longer accurate, removing for simplicity */
        }
        
        .keyboard-recess { /* This replaces .metal-keyboard */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 8px;
            gap: 4px; /* Gap between top and bottom key rows */
            position: relative;
            background-color: #b0b0b0; /* Metallic base color */
            /* Grid background */
            background-image: 
                linear-gradient(rgba(0,0,0,0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.15) 1px, transparent 1px);
            background-size: 12px 12px; /* Size of the grid squares */
            border: 1px solid #777;
            border-radius: 4px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .top-key-row, .bottom-key-row {
            display: flex;
            flex-grow: 1;
            gap: 3px; /* Gap between keys */
        }

        .key {
            background: linear-gradient(to bottom, #d8d8d8 0%, #a0a0a0 50%, #808080 100%);
            border: 1px solid #777;
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.7), inset 0 -1px 2px rgba(0,0,0,0.5);
            transition: background-color 0.05s ease;
            position: relative;
            flex: 1; /* All keys and spacers take equal width */
            z-index: 10;
        }
        .key.key-spacer {
            background: transparent;
            border: none;
            box-shadow: none;
            z-index: 1;
        }

        .top-key-row .key {
            height: 40px; /* Top keys are shorter */
        }

        .bottom-key-row .key {
            height: 50px; /* Bottom keys are taller */
        }

        /* Active key feedback */
        .key.active {
            background: linear-gradient(to bottom, #b0b0b0 0%, #707070 50%, #505050 100%);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
        }

        .bottom-labels-row {
            display: flex;
            height: 18px; /* Height for the bottom label row */
            margin-top: 2px;
            position: relative;
        }

        .bottom-label-segment {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #333;
            font-weight: bold;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        .bottom-label-line {
            /* This is no longer accurate, removing for simplicity */
        }
        /* --- END NEW KEYBOARD STYLES --- */


        .bottom-base {
            background-color: #e0e0e0; /* White bottom base */
            height: 20px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            border-radius: 0 0 12px 12px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            z-index: -1; /* Behind other elements */
        }

        /* Simple stylus cursor */
        .keyboard-recess:hover {
            cursor: crosshair;
        }
    </style>
</head>
<body>

    <div class="stylophone-container">
        <div class="top-section">
            <div class="speaker-area">
                <div class="speaker-grille-bg">
                    <!-- Generate 3 horizontal lines for the grille --><div class="grille-line"></div>
                    <div class="grille-line"></div>
                    <div class="grille-line"></div>
                </div>
            </div>
            <div class="stylophone-logo">Stylophone</div>
            <div class="stylus-slot-area">
                <span class="stylus-label">STYLUS</span>
                <div class="stylus-slot"></div>
            </div>
        </div>

        <div class="middle-controls">
            <div class="left-controls">
                <!-- Power Switch --><div class="switch-group">
                    <label>POWER</label>
                    <div id="power-switch-container" class="toggle-switch-container">
                        <div class="toggle-switch" data-state="off"></div>
                    </div>
                    <div class="flex justify-between w-full text-xs mt-1 px-1"><span>OFF</span><span>ON</span></div>
                </div>

                <!-- Vibrato Switch --><div class="switch-group mt-3">
                    <label>VIBRATO</label>
                    <div id="vibrato-switch-container" class="toggle-switch-container vibrato">
                        <div class="toggle-switch" data-state="off"></div>
                    </div>
                    <div class="flex justify-between w-full text-xs mt-1 px-1"><span>OFF</span><span>ON</span></div>
                </div>

                <!-- Tone Selector --><div class="switch-group mt-3">
                    <label>TONE</label>
                    <div id="tone-selector" class="selector-switch tone">
                        <div class="selector-handle pos1" data-tone="1"></div>
                    </div>
                    <div class="flex justify-between w-full text-xs mt-1 px-1">
                        <span>1</span><span>2</span><span>3</span>
                    </div>
                </div>
            </div>

            <div class="keyboard-area">
                
                <!-- --- NEW SONG PLAYER UI --- -->
                <div class="song-player-controls">
                    <select id="song-selector" title="Select a song">
                        <option value="">Select a song...</option>
                    </select>
                    <button id="play-song-btn">Play</button>
                    <button id="stop-song-btn">Stop</button>
                    <div id="note-display">--</div>
                </div>
                <!-- --- END SONG PLAYER UI --- -->

                <!-- Top Labels Row --><div id="top-labels-row" class="top-labels-row">
                    <!-- Labels generated by JS --></div>

                <!-- Metal Keyboard Area --><div id="keyboard" class="keyboard-recess">
                    <!-- Keys generated by JS --></div>

                <!-- Bottom Labels Row --><div id="bottom-labels-row" class="bottom-labels-row">
                    <!-- Labels generated by JS --></div>
            </div>
        </div>
        <div class="bottom-base"></div>
    </div>

    <script>
        // --- Web Audio Setup ---
        let audioContext;
        let oscillator;
        let gainNode;
        let vibratoLFO;
        let vibratoGain;
        let isPlaying = false;
        let isPoweredOn = false; // Track power state
        let isVibratoOn = false; // Track vibrato state
        let currentTone = 1; // Track tone state (1, 2, or 3)
        let activeKey = null; // Keep track of the highlighted key

        // --- NEW SONG PLAYER VARS ---
        let currentSongTimeout = null;
        let isSongPlaying = false;
        
        /**
         * Helper function to parse song strings.
         * Replaces dashes with spaces, splits by space, and filters empty strings.
         * @param {string} noteString - The raw string of notes from the user.
         * @returns {string[]} An array of note strings.
         */
        function parseSong(noteString) {
            // Replace various dashes with a standard space
            return noteString
                .replace(/–/g, ' ') // Replace en-dashes
                .replace(/-/g, ' ') // Replace hyphens
                .split(/\s+/)       // Split by one or more spaces (handles multi-spaces, newlines)
                .filter(note => note.trim() !== ''); // Remove empty entries
        }

        const songs = [
            // --- Songs I added ---
             {
                name: "Twinkle, Twinkle",
                tempo: 400, 
                notes: ["1", "1", "5", "5", "6", "6", "5", "-", "4", "4", "3", "3", "2", "2", "1", "-", "5", "5", "4", "4", "3", "3", "2", "-", "5", "5", "4", "4", "3", "3", "2", "-", "1", "1", "5", "5", "6", "6", "5", "-", "4", "4", "3", "3", "2", "2", "1"]
            },
            {
                name: "Mary Had a Little Lamb",
                tempo: 300,
                notes: ["3", "2", "1", "2", "3", "3", "3", "-", "2", "2", "2", "-", "3", "5", "5", "-", "3", "2", "1", "2", "3", "3", "3", "3", "2", "2", "3", "2", "1", "-", "-", "-"]
            },
            {
                name: "Row Your Boat",
                tempo: 350,
                notes: ["1", "1", "1", "2", "3", "-", "3", "2", "3", "4", "5", "-", "8", "8", "8", "5", "5", "5", "3", "3", "3", "1", "1", "1", "5", "4", "3", "2", "1", "-", "-", "-"]
            },
            // --- Songs from user list ---
            {
                name: "Pink Panther",
                tempo: 350,
                notes: parseSong("4.5 5 6.5 7 4.5 5 6.5 7 10 9 4.5 5 6 8.5 8 7 5 4 5")
            },
            {
                name: "Star Wars",
                tempo: 400,
                notes: parseSong("1 1 1 4 8 7 6.5 5 11 8 7 6.5 5 11 7 6.5 7 5")
            },
            {
                name: "Happy Birthday",
                tempo: 350,
                notes: parseSong("3 3 4 3 6 5 3 3 4 3 7 6 3 3 10 8 6 6 5 4 8.5 8.5 8 6 7 6")
            },
            {
                name: "Jingle Bells",
                tempo: 300,
                notes: parseSong("5 5 5 5 5 5 5 7 3 4 5 6 6 6 6 6 5 5 5 5 5 4 4 5 4 7 5 5 5 5 5 5 5 7 3 4 5 6 6 6 6 6 5 5 5 5 7 7 6 4 3")
            },
            {
                name: "House of the Rising Sun",
                tempo: 300,
                notes: parseSong("4.5 4.5 6 6.5 8.5 7.5 4.5 4.5 11.5 11.5 11.5 10.5 8.5 7.5 8.5 11.5 11.5 10.5 6.5 7.5 4.5 4.5 4.5 4.5 3.5 1.5 3.5 4.5 11.5 11.5 11.5 10.5 6.5 7.5 6.5 4.5 11.5 11.5 11.5 10.5 7.5 8.5 11.5 11.5 11.5 10.5 6.5 7.5 6.5 4.5 4.5 4.5 3.5 1.5 3.5 4.5")
            },
            {
                name: "Adele - Someone Like You",
                tempo: 300,
                notes: parseSong("8 8 8 7.5 7.5 7.5 6.5 7.5 7.5 8 6.5 6.5 7.5 8 5 5 8 7.5 7.5 8 6.5 8 10.5 10.5 10.5 10.5 12 10.5 11 10.5 9 8 10.5 10.5 10.5 9 8 6.5 8 8 8 8 5 5 5 6.5 5 5 9 8 8")
            },
            {
                name: "A-ha - Take On Me",
                tempo: 250,
                notes: parseSong("5 5 3 1 1 4 4 4 6.5 6.5 7 8 7 7 7 4 2 5 5 5 4 4 5 4")
            },
            {
                name: "Harry Potter",
                tempo: 350,
                notes: parseSong("2 5 7 6.5 5 9 8 6.5 2 5 7 6.5 4.5 6 3 2 5 7 6.5 5 9 11 10.5 10 7.5 10 9 8.5 2 7 5")
            },
            {
                name: "Super Mario Bros",
                tempo: 200,
                notes: parseSong("8 8 8 6 8 10 3 6 3 1 4 5 4.5 4 3 8 10 11 8.5 10 8 6 7 5")
            },
            {
                name: "Megalovania",
                tempo: 180,
                notes: parseSong("4 4 11 8 7.5 7 6 4 6 7 3 3 11 8 7.5 7 6 4 6 7 2 2 11 8 7.5 7 6 4 6 7 1.5 1.5 11 8 7.5 7 6 7 6 4")
            },
            {
                name: "Seven Nation Army",
                tempo: 300,
                notes: parseSong("5 5 7 5 4 3 2 5 5 7 5 4 3 4 3 2")
            },
            {
                name: "AC/DC - Thunderstruck",
                tempo: 150,
                notes: parseSong("2 4.5 2 6.5 2 4.5 2 6.5 2 4.5 2 6.5 2 4.5 2 6.5 2 4.5 2 6.5 2 5 2 7 2 5 2 7 2 5 2 7 2 5 2 7")
            },
            {
                name: "AWOLNATION - Sail",
                tempo: 250,
                notes: parseSong("5 5 5 7 7 7 8 9 8 7 5 5 5 5 7 7 7 8 9 8 7 5 4 4 4 5 5 5 2 5 7 5 4 2 2 2 4 4 4 5 5 5 7 7 7")
            },
            {
                name: "Beatles - Yellow Submarine",
                tempo: 300,
                notes: parseSong("8.5 9 10.5 8.5 7.5 8.5 6.5 8.5 8.5 7.5 6.5 4.5 4.5 8.5 8.5 7.5 10.5 10.5 10.5 10.5 11.5 7.5 7.5 7.5 7.5 7.5 7.5 7.5 7.5 7.5 7.5 6.5 6.5 6.5 6.5 6.5")
            },
            {
                name: "Billie Eilish - bad guy",
                tempo: 250,
                notes: parseSong("7 11 7 10.5 11 10.5 8.5 7 11 7 10.5 11 10.5 8.5 7 11 7 10.5 11 10.5 8.5 3 7 3 6.5 7 6.5 4.5 3 7 3 6.5 7 6.5 4.5 4 8 4 6.5 4 3 3")
            },
            {
                name: "Blondie - Heart of Glass",
                tempo: 250,
                notes: parseSong("10.5 10.5 9 10.5 9 10.5 9 7.5 7.5 7.5 6.5 6.5 6.5 5 10.5 10.5 9 10.5 9 10.5 9 7.5 6 3.5 7.5 7.5 7.5 6.5 6.5 6.5 5")
            },
            {
                name: "David Bowie - Space Oddity",
                tempo: 400,
                notes: parseSong("3 3 3 3 4 3 2 3 3 3 3 4 3 2 3 4 3 4 3 4 3 4 3 4 3 4 3 3 3 3 4 3 2")
            },
            {
                name: "Deep Purple - Smoke on the Water",
                tempo: 300,
                notes: parseSong("3 4.5 6 3 4.5 6.5 6 3 4.5 6 4.5 3")
            },
            {
                name: "Europe - Final Countdown",
                tempo: 250,
                notes: parseSong("10.5 9 10.5 6.5 11 10.5 11 10.5 9 11 10.5 11 6.5 7.5 9 8 9 8 7.5")
            },
            {
                name: "Eurythmics - Sweet Dreams",
                tempo: 250,
                notes: parseSong("10 10 11.5 11.5 7.5 7.5 10 10 7 7 8.5 10")
            },
            {
                name: "Gorillaz - Feel Good Inc",
                tempo: 250,
                notes: parseSong("2 2 3.5 4 7 6.5 5 5 7 6.5 4 2")
            },
            {
                name: "Gotye - Somebody That I Used To Know",
                tempo: 300,
                notes: parseSong("3 3 7 7 8 8.5 10 8 7 6 6 5 5 4 4 3 3 3 7 7 8 8.5 10 8 7 4 4 5 4 4 4 8")
            },
            {
                name: "Michael Jackson - Beat It",
                tempo: 250,
                notes: parseSong("5 7 9 7 5 6.5 5 4 4")
            },
            {
                name: "Joy Division - Love Will Tear Us Apart",
                tempo: 250,
                notes: parseSong("5 6.5 7 6.5 5 4 2 4 1")
            },
            {
                name: "Jurassic Park Theme",
                tempo: 350,
                notes: parseSong("8.5 8 8.5 6 4.5 8.5 8 8.5 6 4.5 8.5 8 8.5 6 1.5 7.5")
            },
            {
                name: "Kraftwerk - The Model",
                tempo: 250,
                notes: parseSong("8 8 10 8 10 8 5 5 7 5 7 8 8 8 10 9 8 9 7 5")
            },
            {
                name: "Led Zeppelin - Stairway To Heaven",
                tempo: 350,
                notes: parseSong("1 3 5 8 9 5 3 9 10 5 3 10 6.5 4 1 6.5 5 7 7 8 8")
            },
            {
                name: "Metallica - Enter Sandman",
                tempo: 250,
                notes: parseSong("5 7 2 1 5 7 2 1 5 7 2 1 7 5 6.5 5 6.5")
            },
            {
                name: "Mission Impossible Theme",
                tempo: 200,
                notes: parseSong("7 7 8.5 10 7 7 6 6.5 7 7 8.5 10 7 7 6 6.5")
            },
            {
                name: "Muse - Uprising",
                tempo: 250,
                notes: parseSong("8 6 4 1 1.5 3 1.5 1 8 5 3.5 1 8.5 10 8.5 8")
            },
            {
                name: "Queen - Under Pressure",
                tempo: 300,
                notes: parseSong("4 4 4 4 4 4 1 7 6.5 6.5 6.5 5 5 5 5 5 5 4 4 4 4 4 4 1")
            },
            {
                name: "Rick Astley - Never Gonna Give You Up",
                tempo: 280,
                notes: parseSong("1 2 4 2 6.5 6.5 5 1 2 4 2 5 5 4 3.5 2 1 2 4 2 4 5 3.5 2 1 1 5 4")
            },
            {
                name: "Soft Cell - Tainted Love",
                tempo: 200,
                notes: parseSong("10 11 7 8.5 7 7 8.5 10 11")
            },
            {
                name: "Spongebob - Theme",
                tempo: 250,
                notes: parseSong("11 12 11 9 7 9 11 12 11 7 8 7 5 3 5 7 8 7")
            },
            {
                name: "Survivor - Eye of The Tiger",
                tempo: 250,
                notes: parseSong("10 10 8.5 10 10 8.5 10 10 7 7.5")
            },
            {
                name: "The Weeknd - Blinding Lights",
                tempo: 200,
                notes: parseSong("6 6 4.5 6 7 3 4.5 6 6 4.5 6 7 3 4.5 8.5 7 6 4.5 8.5 7 6 4.5 6")
            },
            {
                name: "Toto - Africa",
                tempo: 300,
                notes: parseSong("3.5 3.5 3.5 3.5 3.5 2 5 4.5 3.5 4.5 3.5 2 4.5 3.5 3.5 3.5 3.5 3.5 2 5")
            },
            {
                name: "White Stripes - Seven Nation Army",
                tempo: 300,
                notes: parseSong("5 5 7 5 4 3 2 5 5 7 5 4 3 4 3 2")
            },
            {
                name: "Wii Sports Theme",
                tempo: 200,
                notes: parseSong("2 3.5 5 4.5 3.5 2 6.5 4.5 5 6.5 9 8.5 9 6.5 4.5 2 3.5")
            }
        ];


        // Mapping from song tab number (string) to noteFrequencies index
        // This is the correct mapping for the piano-style layout
        const songNoteToNoteIndex = {
            '1': 0,    '1.5': 1,  '2': 2,
            '3.5': 3,  '3': 4,    '4': 5,
            '4.5': 6,  '5': 7,    '6.5': 8,
            '6': 9,    '7.5': 10, '7': 11,
            '8': 12,   '8.5': 13, '9': 14,
            '10.5': 15, '10': 16,  '11': 17,
            '11.5': 18, '12': 19
        };
        // --- END SONG PLAYER VARS ---

        // Frequencies for a Stylophone (C4 to G5, including sharps for 20 keys)
        const noteFrequencies = [
            261.63, 277.18, 293.66, 311.13, 329.63, // C4 to E4
            349.23, 369.99, 392.00, 415.30, 440.00, // F4 to A4
            466.16, 493.88, 523.25, 554.37, 587.33, // A#4 to D5
            622.25, 659.25, 698.46, 739.99, 783.99  // D#5 to G5
        ];

        const numKeys = noteFrequencies.length;

        const keyboard = document.getElementById('keyboard');
        const topLabelsRow = document.getElementById('top-labels-row');
        const bottomLabelsRow = document.getElementById('bottom-labels-row');

        const powerSwitchContainer = document.getElementById('power-switch-container');
        const powerSwitch = powerSwitchContainer.querySelector('.toggle-switch');

        const vibratoSwitchContainer = document.getElementById('vibrato-switch-container');
        const vibratoSwitch = vibratoSwitchContainer.querySelector('.toggle-switch');

        const toneSelector = document.getElementById('tone-selector');
        const toneSelectorHandle = toneSelector.querySelector('.selector-handle');

        // --- NEW SONG PLAYER DOM ELEMENTS ---
        const songSelector = document.getElementById('song-selector');
        const playBtn = document.getElementById('play-song-btn');
        const stopBtn = document.getElementById('stop-song-btn');
        const noteDisplay = document.getElementById('note-display');

        // --- Populate Song Selector ---
        function populateSongSelector() {
            // Sort songs alphabetically
            songs.sort((a, b) => a.name.localeCompare(b.name));
            
            songs.forEach((song, index) => {
                const option = document.createElement('option');
                option.value = index; // Use index as value after sorting
                option.textContent = song.name;
                songSelector.appendChild(option);
            });
        }

        // --- NEW: Key and Label Generation ---
        function generateKeyboardElements() {
            keyboard.innerHTML = ''; // Clear existing keys
            topLabelsRow.innerHTML = ''; // Clear existing labels
            bottomLabelsRow.innerHTML = ''; // Clear existing labels

            // Define the layout based on a piano
            // 12 Bottom ("white") keys
            const bottomKeyIndices = [0, 2, 4, 5, 7, 9, 11, 12, 14, 16, 17, 19];
            const bottomKeyLabels = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            
            // 8 Top ("black") keys
            const topKeyIndices = [1, 3, 6, 8, 10, 13, 15, 18];
            const topKeyLabels = ['1.5', '3.5', '4.5', '6.5', '7.5', '8.5', '10.5', '11.5'];
            
            const topKeyRow = document.createElement('div');
            topKeyRow.className = 'top-key-row';
            
            const bottomKeyRow = document.createElement('div');
            bottomKeyRow.className = 'bottom-key-row';

            let topKeyCounter = 0;
            for (let i = 0; i < bottomKeyLabels.length; i++) {
                // --- Create Bottom Key ---
                const bottomKey = document.createElement('div');
                bottomKey.className = 'key';
                bottomKey.dataset.noteIndex = bottomKeyIndices[i];
                bottomKeyRow.appendChild(bottomKey);

                // --- Create Bottom Label ---
                const bottomLabel = document.createElement('div');
                bottomLabel.className = 'bottom-label-segment';
                bottomLabel.textContent = bottomKeyLabels[i];
                bottomLabelsRow.appendChild(bottomLabel);
            }
            
            // --- Re-build top row with 12 slots for alignment ---
            let topKeyIndex = 0;
            // Gaps at bottom label 3, 6, 10, and after 12
            // THIS IS THE CORRECTED LINE
            const topKeyGapsAt = [2, 5, 9, 11]; 

            for (let i = 0; i < 12; i++) { // 12 slots, one for each bottom key
                const topLabel = document.createElement('div');
                topLabel.className = 'top-label-segment';

                const topKeySlot = document.createElement('div');
                
                if (topKeyGapsAt.includes(i)) {
                    // This is a gap
                    topKeySlot.className = 'key key-spacer'; // Spacer
                    topLabel.className = 'top-label-segment spacer';
                } else {
                    // This is a key
                    topKeySlot.className = 'key';
                    topKeySlot.dataset.noteIndex = topKeyIndices[topKeyIndex];
                    topLabel.textContent = topKeyLabels[topKeyIndex];
                    topKeyIndex++;
                }
                topKeyRow.appendChild(topKeySlot);
                topLabelsRow.appendChild(topLabel);
            }

            keyboard.appendChild(topKeyRow);
            keyboard.appendChild(bottomKeyRow);
        }
        generateKeyboardElements(); // Generate on load
        populateSongSelector(); // NEW: Populate songs

        // --- Initialize Audio ---
        function initAudio() {
            if (audioContext) return; // Already initialized

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                oscillator = audioContext.createOscillator();
                gainNode = audioContext.createGain();
                vibratoLFO = audioContext.createOscillator();
                vibratoGain = audioContext.createGain();

                oscillator.type = 'sawtooth'; // A classic retro synth sound
                oscillator.connect(gainNode);

                // Vibrato setup
                vibratoLFO.type = 'sine';
                vibratoLFO.frequency.value = 6; // Vibrato speed (Hz)
                vibratoGain.gain.value = 0; // Start with no vibrato depth
                vibratoLFO.connect(vibratoGain);
                vibratoGain.connect(oscillator.detune); // Connect LFO to oscillator detune for pitch modulation
                vibratoLFO.start(0);

                gainNode.connect(audioContext.destination);

                gainNode.gain.value = 0; // Start silent
                oscillator.start(0);
                console.log("Audio initialized.");
            } catch (e) {
                console.error("Web Audio API is not supported in this browser", e);
                // Use a less obtrusive error message
                const errorDiv = document.createElement('div');
                errorDiv.textContent = "Sorry, your browser doesn't support the Web Audio API.";
                errorDiv.className = "text-red-500 bg-white p-4 rounded-lg shadow-lg fixed top-4 left-1/2 -translate-x-1/2 z-50";
                document.body.appendChild(errorDiv);
            }
        }

        // --- Sound Control ---
        function playNote(noteIndex) {
            if (!audioContext || !isPoweredOn || noteIndex < 0 || noteIndex >= noteFrequencies.length) {
                stopSound(); // Ensure sound stops if power is off or invalid note
                return;
            }

            const frequency = noteFrequencies[noteIndex];
            
            // Apply tone adjustment (simple shift for now)
            let adjustedFrequency = frequency;
            if (currentTone === 2) { // Example: Shift down a bit
                adjustedFrequency *= 0.95; 
            } else if (currentTone === 3) { // Example: Shift up a bit
                adjustedFrequency *= 1.05;
            }

            // Set frequency with a slight glide (portamento)
            oscillator.frequency.setTargetAtTime(adjustedFrequency, audioContext.currentTime, 0.01);

            if (!isPlaying) {
                // Ramp up volume quickly
                gainNode.gain.setTargetAtTime(0.3, audioContext.currentTime, 0.005);
                isPlaying = true;
            }
        }

        function stopSound() {
            if (!audioContext || !isPlaying) return;
            // Ramp down volume quickly
            gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.01);
            isPlaying = false;
        }

        // --- NEW: Helper to stop sound and unhighlight key ---
        function stopSoundAndUnhighlight() {
            stopSound();
            if (activeKey) {
                activeKey.classList.remove('active');
                activeKey = null;
            }
        }

        function updateVibrato() {
            if (vibratoGain) {
                // Depth of vibrato (in cents)
                vibratoGain.gain.setTargetAtTime(isVibratoOn && isPoweredOn ? 50 : 0, audioContext.currentTime, 0.05);
            }
        }

        // --- NEW SONG PLAYER FUNCTIONS ---
        function playSong() {
            if (!isPoweredOn) {
                // Flash the power switch to indicate it needs to be on
                powerSwitchContainer.style.backgroundColor = '#ef9a9a'; // Light red
                setTimeout(() => { powerSwitchContainer.style.backgroundColor = '#999'; }, 500);
                return;
            }
            if (isSongPlaying) {
                stopSong();
            }
            
            const songIndex = songSelector.value;
            if (songIndex === "") return; // No song selected

            // Find the song by index (since we sorted the list)
            const song = songs[songIndex];
            isSongPlaying = true;
            playBtn.disabled = true;
            songSelector.disabled = true;

            let noteCounter = 0;

            function playNextNote() {
                // Stop previous note
                stopSoundAndUnhighlight(); 

                if (!isSongPlaying || noteCounter >= song.notes.length) {
                    stopSong(); // Song is over
                    return;
                }

                const noteString = song.notes[noteCounter];
                const noteIndex = songNoteToNoteIndex[noteString];

                if (noteIndex !== undefined) {
                    playNote(noteIndex);
                    // Find and highlight the key
                    activeKey = keyboard.querySelector(`.key[data-note-index="${noteIndex}"]`);
                    if (activeKey) {
                        activeKey.classList.add('active');
                    }
                    noteDisplay.textContent = noteString;
                    
                    // Schedule this note to stop ~50ms before the next note, creating a gap
                    // Ensure tempo is not too fast
                    const stopDelay = Math.max(50, song.tempo - 50);
                    setTimeout(stopSoundAndUnhighlight, stopDelay); 
                } else {
                    // This is a pause or invalid note
                    stopSound(); // Ensure sound is off
                    noteDisplay.textContent = "-";
                    // Note: No sound will play, creating a pause for the duration of `song.tempo`
                }

                noteCounter++;
                // Schedule the *next* note
                currentSongTimeout = setTimeout(playNextNote, song.tempo);
            }

            playNextNote();
        }

        function stopSong() {
            isSongPlaying = false;
            if (currentSongTimeout) {
                clearTimeout(currentSongTimeout);
                currentSongTimeout = null;
            }
            stopSoundAndUnhighlight(); // Use new helper
            noteDisplay.textContent = "--";
            playBtn.disabled = false;
            songSelector.disabled = false;
        }

        // --- END SONG PLAYER FUNCTIONS ---

        // --- Event Listeners ---
        let isMouseDown = false;
        // activeKey is now a global variable at the top of the script

        function getNoteIndexFromEvent(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // Check if interaction is directly on a key
            let targetElement = document.elementFromPoint(clientX, clientY);
            let keyElement = targetElement ? targetElement.closest('.key:not(.key-spacer)') : null; // Ignore spacers

            if (keyElement && keyElement.dataset.noteIndex) {
                return parseInt(keyElement.dataset.noteIndex, 10);
            }
            
            // Fallback for dragging removed, as it's no longer a linear keyboard
            return -1; // Not over a valid key area
        }

        function handleInteractionStart(e) {
            e.preventDefault(); 
            if (!isPoweredOn) return; // Only interact if powered on
            
            if (isSongPlaying) { // NEW: Stop song on manual play
                stopSong();
            }

            initAudio(); // Initialize audio on first user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            isMouseDown = true;
            const noteIndex = getNoteIndexFromEvent(e);
            
            stopSoundAndUnhighlight(); // Deactivate previous key

            if (noteIndex !== -1) {
                playNote(noteIndex);
                // Find the key element in DOM to highlight it
                activeKey = keyboard.querySelector(`.key[data-note-index="${noteIndex}"]`);
                if(activeKey) activeKey.classList.add('active');
            } else {
                stopSound(); // If clicked off a key, stop sound
            }
        }

        function handleInteractionMove(e) {
            e.preventDefault();
            if (!isMouseDown || !isPoweredOn) return;

            const noteIndex = getNoteIndexFromEvent(e);
            const newActiveKey = noteIndex !== -1 ? keyboard.querySelector(`.key[data-note-index="${noteIndex}"]`) : null;

            if (newActiveKey && newActiveKey !== activeKey) {
                // Moved to a new key
                stopSoundAndUnhighlight(); // Stop old note
                activeKey = newActiveKey;
                activeKey.classList.add('active');
                playNote(noteIndex);
            } else if (!newActiveKey && activeKey) {
                // Moved off a key
                stopSoundAndUnhighlight();
            }
        }

        function handleInteractionEnd(e) {
            e.preventDefault();
            isMouseDown = false;
            stopSoundAndUnhighlight(); // Use helper
        }

        // --- Control Switches ---
        powerSwitchContainer.addEventListener('click', () => {
            isPoweredOn = !isPoweredOn;
            powerSwitch.dataset.state = isPoweredOn ? 'on' : 'off';
            powerSwitch.classList.toggle('on', isPoweredOn);
            if (!isPoweredOn) {
                stopSound();
                // Also turn off vibrato visually if power is off
                isVibratoOn = false;
                vibratoSwitch.dataset.state = 'off';
                vibratoSwitch.classList.remove('on');
                stopSong(); // NEW: Stop song when power is off
            }
            updateVibrato(); // Update vibrato state based on power
            console.log("Power:", isPoweredOn ? "ON" : "OFF");
        });

        vibratoSwitchContainer.addEventListener('click', () => {
            if (!isPoweredOn) return; // Can't turn on vibrato if power is off
            isVibratoOn = !isVibratoOn;
            vibratoSwitch.dataset.state = isVibratoOn ? 'on' : 'off';
            vibratoSwitch.classList.toggle('on', isVibratoOn);
            updateVibrato();
            console.log("Vibrato:", isVibratoOn ? "ON" : "OFF");
        });

        toneSelector.addEventListener('click', () => {
            currentTone = (currentTone % 3) + 1; // Cycle 1 -> 2 -> 3 -> 1
            toneSelectorHandle.dataset.tone = currentTone;
            // Update handle position
            if (currentTone === 1) {
                toneSelectorHandle.className = 'selector-handle pos1';
            } else if (currentTone === 2) {
                toneSelectorHandle.className = 'selector-handle pos2';
            } else if (currentTone === 3) {
                toneSelectorHandle.className = 'selector-handle pos3';
            }
            
            console.log("Tone:", currentTone);
            // If a note is currently playing, update its frequency
            if (isPlaying && activeKey) {
                playNote(parseInt(activeKey.dataset.noteIndex, 10));
            }
        });

        // --- NEW: Song Player Event Listeners ---
        playBtn.addEventListener('click', playSong);
        stopBtn.addEventListener('click', stopSong);


        // Mouse Events
        const keyboardRecess = document.getElementById('keyboard');
        keyboardRecess.addEventListener('mousedown', handleInteractionStart);
        keyboardRecess.addEventListener('mousemove', handleInteractionMove);
        
        window.addEventListener('mouseup', handleInteractionEnd);
        keyboardRecess.addEventListener('mouseleave', (e) => {
            if (isMouseDown) { // Only stop if the mouse button is still down
                stopSoundAndUnhighlight(); // Use helper
            }
        });

        // Touch Events
        keyboardRecess.addEventListener('touchstart', handleInteractionStart);
        keyboardRecess.addEventListener('touchmove', handleInteractionMove);
        keyboardRecess.addEventListener('touchend', handleInteractionEnd);
        keyboardRecess.addEventListener('touchcancel', handleInteractionEnd);

    </script>
</body>
</html>

